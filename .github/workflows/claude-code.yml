name: Claude Code Review

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]

jobs:
  claude-review:
    # Only run if comment contains @claude mention
    if: |
      github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude') ||
      github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')

    runs-on: ubuntu-latest

    permissions:
      contents: read
      pull-requests: write
      issues: write

    steps:
      - name: Check if PR comment
        id: check-pr
        run: |
          if [ "${{ github.event.issue.pull_request }}" != "" ]; then
            echo "is_pr=true" >> $GITHUB_OUTPUT
            # Extract PR number from issue
            echo "pr_number=${{ github.event.issue.number }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.pull_request }}" != "" ]; then
            echo "is_pr=true" >> $GITHUB_OUTPUT
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          else
            echo "is_pr=false" >> $GITHUB_OUTPUT
          fi

      - name: Get PR details
        if: steps.check-pr.outputs.is_pr == 'true'
        id: pr-details
        uses: actions/github-script@v7
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ steps.check-pr.outputs.pr_number }}
            });

            core.setOutput('head_ref', pr.data.head.ref);
            core.setOutput('head_sha', pr.data.head.sha);
            core.setOutput('base_ref', pr.data.base.ref);

      - name: Checkout PR branch
        if: steps.check-pr.outputs.is_pr == 'true'
        uses: actions/checkout@v4
        with:
          ref: ${{ steps.pr-details.outputs.head_ref }}
          fetch-depth: 0

      - name: React to comment
        uses: actions/github-script@v7
        with:
          script: |
            const commentId = context.payload.comment.id;
            await github.rest.reactions.createForIssueComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              content: 'eyes'
            });

      - name: Run Claude Code review
        if: steps.check-pr.outputs.is_pr == 'true'
        uses: anthropics/anthropic-review-action@v1
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          anthropic-api-key: ${{ secrets.ANTHROPIC_API_KEY }}
          # Optional: Customize Claude's behavior
          # model: claude-sonnet-4-5-20250929
          # max-tokens: 8000

      - name: Comment if not a PR
        if: steps.check-pr.outputs.is_pr == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'ðŸ‘‹ Hi! I can only review pull requests. Please mention me (@claude) in a PR comment.'
            });
